<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pixel Racer</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
html,body{
  margin:0;
  background:#000;
  overflow:hidden;
  touch-action:none;
}
canvas{
  display:block;
  margin:auto;
  image-rendering:pixelated;
}
#controls{
  position:fixed;
  bottom:20px;
  width:100%;
  display:flex;
  justify-content:space-between;
  padding:0 20px;
}
.btn{
  width:80px;
  height:80px;
  background:#333;
  color:#fff;
  font-size:32px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div id="controls">
  <div class="btn" id="left">◀</div>
  <div class="btn" id="right">▶</div>
</div>

<script>
// ---------- PWA ----------
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

// ---------- CANVAS ----------
const BASE_W=240, BASE_H=320;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

function resize(){
  const s=Math.floor(Math.min(innerWidth/BASE_W,innerHeight/BASE_H));
  canvas.width=BASE_W*s;
  canvas.height=BASE_H*s;
  ctx.setTransform(s,0,0,s,0,0);
}
addEventListener("resize",resize); resize();

// ---------- SES (iOS UYUMLU) ----------
let audioCtx;
function beep(freq,dur){
  if(!audioCtx) audioCtx=new (window.AudioContext||webkitAudioContext)();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur);
  o.stop(audioCtx.currentTime+dur);
}

// ---------- OYUNCU ----------
const player={x:112,y:260,w:16,h:28,speed:3};

// ---------- PIXEL ART ARABA ----------
function drawCar(x,y,c){
  ctx.fillStyle=c;
  ctx.fillRect(x+4,y,8,4);
  ctx.fillRect(x,y+4,16,16);
  ctx.fillRect(x+4,y+20,8,8);
}

// ---------- OYUN DURUMU ----------
let enemies=[],frame=0;
let score=0;
let level=1;
let high=localStorage.high||0;
let gameOver=false;
let left=false,right=false;

// ---------- BUTONLAR ----------
["left","right"].forEach(id=>{
  const el=document.getElementById(id);
  el.ontouchstart=()=>{audioCtx?.resume(); id==="left"?left=true:right=true};
  el.ontouchend=()=>left=right=false;
});

// ---------- ENGELLER ----------
function spawnEnemy(){
  enemies.push({
    x:Math.random()*180+20,
    y:-30,
    s:2+level*0.5
  });
}

// ---------- DÖNGÜ ----------
function loop(){
  ctx.fillStyle="#333";
  ctx.fillRect(0,0,BASE_W,BASE_H);

  ctx.strokeStyle="#fff";
  ctx.setLineDash([6,6]);
  ctx.beginPath();
  ctx.moveTo(120,0);
  ctx.lineTo(120,320);
  ctx.stroke();
  ctx.setLineDash([]);

  if(!gameOver){
    if(left && player.x>10) player.x-=player.speed;
    if(right && player.x<BASE_W-player.w-10) player.x+=player.speed;

    if(frame%Math.max(80-level*5,30)===0) spawnEnemy();

    enemies.forEach(e=>{
      e.y+=e.s;
      drawCar(e.x,e.y,"yellow");
      if(
        e.x<player.x+player.w &&
        e.x+16>player.x &&
        e.y<player.y+player.h &&
        e.y+28>player.y
      ){
        beep(80,0.3);
        gameOver=true;
        high=Math.max(high,score);
        localStorage.high=high;
      }
    });

    enemies=enemies.filter(e=>e.y<320);
    drawCar(player.x,player.y,"red");

    score++;
    level=1+Math.floor(score/500);
    frame++;
  }else{
    ctx.fillStyle="#fff";
    ctx.font="14px monospace";
    ctx.fillText("GAME OVER",60,140);
    ctx.fillText("SKOR "+score,70,170);
    ctx.fillText("REKOR "+high,65,190);
    ctx.fillText("DOKUN = YENİDEN",30,220);
  }

  ctx.fillStyle="#fff";
  ctx.font="10px monospace";
  ctx.fillText("LV "+level,10,14);

  requestAnimationFrame(loop);
}

canvas.onclick=()=>{
  if(gameOver){
    enemies=[]; score=0; frame=0; level=1;
    player.x=112; gameOver=false;
    beep(440,0.1);
  }
};

loop();
</script>
</body>
</html>